name: CI

on:
    push:
    pull_request:
            
jobs:
    build:
        name: Build as JS package
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: oven-sh/setup-bun@v2
            - run: bun install
            - run: bun run build
            - uses: actions/upload-artifact@v4
              with:
                  name: dist
                  path: dist/
    
    compile:
        name: Compile to binary
        needs: build
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]
        runs-on: ${{ matrix.os }}
        steps:
            - uses: actions/checkout@v4
            - uses: oven-sh/setup-bun@v2
            - uses: actions/download-artifact@v4
              with:
                  name: dist
                  path: dist/
            - run: bun install --production
            - name: Compile binary
              run: bun run compile
            - name: Upload binary artifact
              uses: actions/upload-artifact@v4
              with:
                  name: napi-ws-${{ matrix.os }}
                  path: |
                      bin/napi-ws
                      bin/napi-ws.exe
                  if-no-files-found: ignore